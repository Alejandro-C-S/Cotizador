{% extends 'base1.html' %}
{% block title %} Gestor de Productos {% endblock %}
{% block content %}
    <div class="container my-5">
        <h2 class="text-center mb-4 text-danger fw-bold">Gestor de Productos</h2>
        <div class="card shadow-lg border-0 mx-auto p-4" style="max-width: 950px;">
            <div class="card-body">
                <form class="row g-3" method="post">
                    <input type="hidden" name="idProducto" id="idProducto" value="{{ editar.idproducto if editar else '' }}">
                    <input type="hidden" name="idMaterial" id="idMaterial" value="{{ editar.idmaterial if editar else '' }}">
                    <input type="hidden" name="idPrecio" id="idPrecio" value="{{ editar.idprecio if editar else '' }}">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Perfil</label>
                        <input type="text" name="taskPerfil" id="taskPerfil" class="form-control shadow-sm" value="{{ editar.perfil if editar else '' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Material</label>
                        <input type="text" name="taskMaterial" id="taskMaterial" class="form-control shadow-sm" value="{{ editar.material if editar else '' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Precio</label>
                        <input type="text" name="taskPrecio" id="taskPrecio" class="form-control shadow-sm" value="{{ editar.precio if editar else '' }}" required>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary me-5" type="submit" name="accion" value="actualizar">
                            <i class="bi bi-pencil-square"></i> Editar
                        </button>
                        <button type="button" class="btn btn-purple me-5" data-bs-toggle="modal" data-bs-target="#ModalPerfil" data-bs-whatever="@mdo">
                            <i class="bi bi-box"></i> Nuevo Producto
                        </button>
                        <button type="button" class="btn btn-orange me-5" data-bs-toggle="modal" data-bs-target="#ModalMaterial" data-bs-whatever="@mdo">
                            <i class="bi bi-wrench"></i> Nuevo Material
                        </button>
                        <button type="button" class="btn btn-danger me-5" data-bs-toggle="modal" data-bs-target="#ModalEliminarPerfil">
                            <i class="bi bi-trash"></i> Eliminar Perfil
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dentro de producto.html -->
        <div class="modal fade" id="ModalPerfil" tabindex="-1" aria-labelledby="ModalPerfilLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content shadow-lg rounded-3">
                    <div class="modal-header bg-purple text-white">
                        <h5 class="modal-title fw-bold" id="ModalPerfilLabel">Nuevo Perfil</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="{{ url_for('producto') }}">
                            <input type="hidden" name="accion" value="agregar_perfil">
                            <div class="mb-3">
                                <label for="nombrePerfil" class="form-label fw-bold">Nombre</label>
                                <input type="text" class="form-control" id="nombrePerfil" name="nombrePerfil" placeholder="Ingrese el nombre del perfil" required>
                            </div>
                            <h6 class="fw-bold">Selecciona tus opciones:</h6>
                            <div class="row">
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox1" name="checkbox1">
                                        <label class="form-check-label" for="checkbox1">Diámetro</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox2" name="checkbox2">
                                        <label class="form-check-label" for="checkbox2">Longitud</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox3" name="checkbox3">
                                        <label class="form-check-label" for="checkbox3">Ancho</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox4" name="checkbox4">
                                        <label class="form-check-label" for="checkbox4">Alto</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox5" name="checkbox5">
                                        <label class="form-check-label" for="checkbox5">Espesor</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox6" name="checkbox6">
                                        <label class="form-check-label" for="checkbox6">Volumen Final</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox7" name="checkbox7">
                                        <label class="form-check-label" for="checkbox7">N° de Cortes</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox8" name="checkbox8">
                                        <label class="form-check-label" for="checkbox8">Vmm^3</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checkbox9" name="checkbox9">
                                        <label class="form-check-label" for="checkbox9">Kg</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="calculo" class="form-label fw-bold">Tipo de calculo</label>
                                <div class="d-flex align-items-center">
                                    <select name="calculo" id="calculo" class="form-select shadow-sm me-2" required>
                                        <option value="" class="fw-bold text-primary">Seleccione un un calculo</option>
                                        {% for calculo in tipos_calculo %}
                                            <option value="{{ calculo }}">{{ calculo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button class="btn btn-purple" type="submit">
                                    <i class="bi bi-plus-circle"></i> Agregar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

       <!-- Modal para agregar material -->
       <div class="modal fade" id="ModalMaterial" tabindex="-1" aria-labelledby="ModalMaterialLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-orange text-white">
                    <h5 class="modal-title fw-bold" id="ModalMaterialLabel">Nuevo Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="formAgregarMaterial" action="{{ url_for('producto') }}" method="POST">
                        <input type="hidden" name="accion" value="agregar_material">
    
                        <div class="mb-4 d-flex align-items-end gap-2">
                            <div class="flex-grow-1">
                                <label for="taskPerfil" class="form-label fw-bold">Tipo de Perfil</label>
                                <select name="taskPerfil" id="taskPerfil" class="form-select shadow-sm" required>
                                    <option value="">Seleccione un perfil existente</option>
                                    {% for perfil in tipos_perfil %}
                                        <option value="{{ perfil }}">{{ perfil }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
    
                        <div class="mb-4">
                            <label for="taskMaterial" class="form-label fw-bold">Material</label>
                            <input type="text" class="form-control shadow-sm" id="taskMaterial" name="taskMaterial" placeholder="Ingrese el nombre del material" required>
                        </div>
    
                        <div class="mb-4">
                            <label for="densidadMaterial" class="form-label fw-bold">Densidad</label>
                            <input type="text" class="form-control shadow-sm" id="densidadMaterial" name="densidadMaterial" placeholder="Ingrese la densidad" required>
                        </div>
    
                        <div class="mb-4">
                            <label for="precioMaterial" class="form-label fw-bold">Precio</label>
                            <input type="number" step="0.01" class="form-control shadow-sm" id="precioMaterial" name="precioMaterial" placeholder="Ingrese el precio">  
                        </div>
    
                        <div class="modal-footer justify-content-center">
                            <button class="btn btn-orange" type="submit">
                                <i class="bi bi-plus-circle"></i> Agregar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminación de perfil -->
<div class="modal fade" id="ModalEliminarPerfil" tabindex="-1" aria-labelledby="ModalEliminarPerfilLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg rounded-3">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold" id="ModalEliminarPerfilLabel">Eliminar Tipo de Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Ingrese el nombre del tipo de perfil a eliminar para confirmar la acción:</p>
                <form method="post" action="{{ url_for('eliminar_perfil') }}">
                    <input type="hidden" name="idPerfil" id="idPerfilEliminar">
                    <div class="mb-3">
                        <label for="tipoPerfilEliminar" class="form-label fw-bold">Tipo de Perfil</label>
                        <input type="text" class="form-control" id="tipoPerfilEliminar" name="tipoPerfil" placeholder="Ingrese el tipo de perfil" required>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Confirmar Eliminación
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
        
        {% if mensaje_error %}
            <div class="alert alert-danger text-center mt-4">
                {{ mensaje_error }}
            </div>
        {% endif %}

        {% if mensaje_exito %}
            <div class="alert alert-success text-center mt-4">
                {{ mensaje_exito }}
            </div>
        {% endif %}

        <div class="table-responsive mt-4" style="max-height: 234px;">
            <table class="table table-bordered table-hover shadow-sm overflow-y-auto">
                <thead class="table-primary" style="position: sticky; top: 0; z-index: 2;">
                    <tr class="text-center">
                        <th>Tipo de perfil</th>
                        <th>Material</th>
                        <th>Precio</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                        {% for material in producto.materiales %}
                            {% set precio = material.precio[0].precio if material.precio and material.precio|length > 0 else 'No disponible' %}
                            <tr class="text-center align-middle" id="{{ producto.idproducto }}" 
                            onclick="seleccionarFila('{{ producto.idproducto }}', '{{ producto.tipo_perfil }}', '{{ material.nombre }}', '{{ precio }}', '{{ material.idmaterial }}', '{{ material.precio[0].idprecio if material.precio else '' }}')">
                                <td class="fw-bold">{{ producto.tipo_perfil }}</td>
                                <td>{{ material.nombre }}</td>
                                <td>${{ precio }}</td>
                                <td>
                                    <a href="{{ url_for('eliminar_material', id=material.idmaterial) }}" class="btn btn-danger btn-sm">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="seleccionarPerfilEliminar('{{ producto.idproducto }}', '{{ producto.tipo_perfil }}')" data-bs-toggle="modal" data-bs-target="#ModalEliminarPerfil">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>

                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
        function seleccionarFila(idproducto, perfil, material, precio, idmaterial, idprecio) {
            document.getElementById('idProducto').value = idproducto;
            document.getElementById('taskPerfil').value = perfil;
            document.getElementById('taskMaterial').value = material;
            document.getElementById('taskPrecio').value = precio;
            document.getElementById('idMaterial').value = idmaterial || '';
            document.getElementById('idPrecio').value = idprecio || '';
        }

        function seleccionarPerfilEliminar(idPerfil, tipoPerfil) {
            document.getElementById('idPerfilEliminar').value = idPerfil;
            document.getElementById('tipoPerfilEliminar').value = tipoPerfil;
        }
        </script>
{% endblock %}